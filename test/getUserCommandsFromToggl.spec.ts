// @ts-ignore TS6059
// Only for test purpose, isn't compiled to js sources
import { mockCurrentDate } from './mocks/currentDate'
import { render } from '../src/toggl/entriesList'
import togglApi, { GetEntriesRequest, GetEntriesResponse } from '../src/api/togglapi'

jest.mock('../src/config/configStore', () => jest.requireActual('./mocks/configStore'))

afterEach(() => { jest.clearAllMocks() })

describe('get user commands from Toggl', () => {
    mockGetEntriesResponse({
        total_billable: 0,
        total_currencies: 0,
        total_grand: 0,
        data: [
            {
                id: 2681572359,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'QB-1444: PR',
                start: '2022-10-10T16:31:28+02:00',
                end: '2022-10-10T17:11:44+02:00',
                updated: '2022-10-11T17:35:47+02:00',
                dur: 2416000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681467924,
                pid: 149288363,
                tid: 22591281,
                uid: 6460477,
                description: 'QB-1463',
                start: '2022-10-10T14:59:33+02:00',
                end: '2022-10-10T16:31:28+02:00',
                updated: '2022-10-11T17:38:19+02:00',
                dur: 5515000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'DEV',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681347084,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'Research: How does Netflix use graphql',
                start: '2022-10-10T14:34:24+02:00',
                end: '2022-10-10T14:59:24+02:00',
                updated: '2022-10-11T17:38:13+02:00',
                dur: 1500000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681254035,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'SOPS-136',
                start: '2022-10-10T13:38:40+02:00',
                end: '2022-10-10T14:34:23+02:00',
                updated: '2022-10-11T17:38:07+02:00',
                dur: 3343000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681219068,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'SOPS-191',
                start: '2022-10-10T13:15:22+02:00',
                end: '2022-10-10T13:38:40+02:00',
                updated: '2022-10-11T17:38:04+02:00',
                dur: 1398000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681202099,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'QB-1190',
                start: '2022-10-10T13:03:58+02:00',
                end: '2022-10-10T13:15:22+02:00',
                updated: '2022-10-11T17:37:59+02:00',
                dur: 684000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681197235,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'SOPS-196',
                start: '2022-10-10T13:01:06+02:00',
                end: '2022-10-10T13:03:58+02:00',
                updated: '2022-10-11T14:59:06+02:00',
                dur: 172000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681184301,
                pid: 149288363,
                tid: 22591283,
                uid: 6460477,
                description: 'SOPS-195',
                start: '2022-10-10T12:52:50+02:00',
                end: '2022-10-10T13:01:06+02:00',
                updated: '2022-10-11T14:59:01+02:00',
                dur: 496000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681162283,
                pid: 149288363,
                tid: 22591279,
                uid: 6460477,
                description: 'Issue test env: Wrong model id',
                start: '2022-10-10T12:37:08+02:00',
                end: '2022-10-10T12:52:50+02:00',
                updated: '2022-10-11T14:58:56+02:00',
                dur: 942000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'BUG',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681148386,
                pid: 178068202,
                tid: 77653090,
                uid: 6460477,
                description: 'ES-1103',
                start: '2022-10-10T12:27:39+02:00',
                end: '2022-10-10T12:37:08+02:00',
                updated: '2022-10-11T14:58:47+02:00',
                dur: 569000,
                user: 'Tim',
                use_stop: true,
                client: 'CBRE',
                project: 'CBRE SAFE - 2022',
                project_color: '0',
                project_hex_color: '#991102',
                task: 'ANALYSIS',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2681038457,
                pid: 149288363,
                tid: 25061347,
                uid: 6460477,
                description: 'Mails',
                start: '2022-10-10T11:14:18+02:00',
                end: '2022-10-10T12:27:38+02:00',
                updated: '2022-10-10T12:27:39+02:00',
                dur: 4400000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'PM',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2680854332,
                pid: 149288363,
                tid: 22591282,
                uid: 6460477,
                description: 'QB-1444',
                start: '2022-10-10T09:22:32+02:00',
                end: '2022-10-10T10:35:05+02:00',
                updated: '2022-10-10T10:35:07+02:00',
                dur: 4353000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'MEETING',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2680839614,
                pid: 149288348,
                tid: 22591277,
                uid: 6460477,
                description: 'Daily',
                start: '2022-10-10T09:00:49+02:00',
                end: '2022-10-10T09:22:32+02:00',
                updated: '2022-10-10T09:22:34+02:00',
                dur: 1303000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - Live',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'MEETING',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            },
            {
                id: 2680787548,
                pid: 149288363,
                tid: 25061347,
                uid: 6460477,
                description: 'Mails',
                start: '2022-10-10T08:34:49+02:00',
                end: '2022-10-10T09:12:49+02:00',
                updated: '2022-10-10T10:35:03+02:00',
                dur: 2280000,
                user: 'Tim',
                use_stop: true,
                client: 'Onyx',
                project: 'Onyx One - 2.0',
                project_color: '0',
                project_hex_color: '#c7af14',
                task: 'PM',
                billable: null,
                is_billable: false,
                cur: null,
                tags: []
            }
        ]

    })
    mockCurrentDate(new Date('2022-10-10T12:00:00.000+01:00'))

    test('Matches the expected commands', async () => {
        const entries = await togglApi.getEntries({
            since: '2022-10-10',
            until: '2022-10-10',
            user_agent: '',
            user_ids: 1,
            workspace_id: 1
        })

        const result = render(entries.data)

        expect(result).toStrictEqual([
            'tempo l QB-1444 40m 2022-10-10 -w CodeReview -d "PR"',
            'tempo l QB-1463 1h32m 2022-10-10 -w Development',
            'tempo l OV-57 25m 2022-10-10 -w Overhead:Meetings -d "Research: How does Netflix use graphql"',
            'tempo l SOPS-136 56m 2022-10-10 -w Analysis',
            'tempo l SOPS-191 23m 2022-10-10 -w Analysis',
            'tempo l QB-1190 11m 2022-10-10 -w Analysis',
            'tempo l SOPS-196 3m 2022-10-10 -w Analysis',
            'tempo l SOPS-195 8m 2022-10-10 -w Analysis',
            'tempo l OV-57 16m 2022-10-10 -w Overhead:Meetings -d "Issue test env: Wrong model id"',
            'tempo l ES-1103 9m 2022-10-10 -w Analysis',
            'tempo l OV-57 1h13m 2022-10-10 -w Overhead:Meetings -d "Mails"',
            'tempo l QB-1444 1h13m 2022-10-10 -w Analysis',
            'tempo l OV-408 22m 2022-10-10 -w Overhead:AdministrativeTasks -d "Daily"',
            'tempo l OV-57 38m 2022-10-10 -w Overhead:Meetings -d "Mails"'
        ])
    })
})

function mockGetEntriesResponse (response: GetEntriesResponse) {
    const getWorklogsMock = jest.fn(async (request: GetEntriesRequest) => {
        return Promise.resolve<GetEntriesResponse>(response)
    })

    togglApi.getEntries = getWorklogsMock
}
